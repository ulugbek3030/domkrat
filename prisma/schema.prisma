generator client {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
  previewFeatures = ["fullTextSearchPostgres"]
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// USERS & AUTH
// ============================================================

enum UserRole {
  CUSTOMER
  ADMIN
  MANAGER
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  phone          String?   @unique
  passwordHash   String?
  firstName      String
  lastName       String
  image          String?
  role           UserRole  @default(CUSTOMER)
  emailVerified  DateTime?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  addresses      Address[]
  orders         Order[]
  cart           Cart?
  wishlistItems  WishlistItem[]
  sessions       Session[]
  accounts       Account[]

  @@index([email])
  @@index([phone])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Address {
  id         String  @id @default(cuid())
  userId     String
  label      String?
  firstName  String
  lastName   String
  phone      String
  city       String
  district   String?
  street     String
  building   String?
  apartment  String?
  landmark   String?
  isDefault  Boolean @default(false)

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  @@index([userId])
}

// ============================================================
// PRODUCTS & CATEGORIES
// ============================================================

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  image       String?
  parentId    String?
  sortOrder   Int        @default(0)
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@index([parentId])
  @@index([slug])
}

model Product {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  description     String?
  shortDesc       String?
  sku             String   @unique
  oemNumber       String?
  brandName       String?
  price           Decimal  @db.Decimal(12, 2)
  compareAtPrice  Decimal? @db.Decimal(12, 2)
  costPrice       Decimal? @db.Decimal(12, 2)
  weight          Decimal? @db.Decimal(8, 2)
  isActive        Boolean  @default(true)
  isFeatured      Boolean  @default(false)
  categoryId      String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  category        Category              @relation(fields: [categoryId], references: [id])
  images          ProductImage[]
  specifications  ProductSpecification[]
  vehicleLinks    ProductVehicle[]
  crossReferences OemCrossReference[]
  cartItems       CartItem[]
  orderItems      OrderItem[]
  wishlistItems   WishlistItem[]
  inventory       Inventory?
  stockMovements  StockMovement[]

  @@index([slug])
  @@index([sku])
  @@index([oemNumber])
  @@index([categoryId])
  @@index([brandName])
  @@index([isActive, isFeatured])
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  url       String
  alt       String?
  sortOrder Int     @default(0)
  isPrimary Boolean @default(false)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model ProductSpecification {
  id        String @id @default(cuid())
  productId String
  name      String
  value     String
  sortOrder Int    @default(0)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

// ============================================================
// VEHICLE COMPATIBILITY SYSTEM
// ============================================================

model VehicleMake {
  id        String         @id @default(cuid())
  name      String         @unique
  slug      String         @unique
  logo      String?
  sortOrder Int            @default(0)
  isActive  Boolean        @default(true)

  models    VehicleModel[]

  @@index([slug])
}

model VehicleModel {
  id        String         @id @default(cuid())
  name      String
  slug      String
  makeId    String
  isActive  Boolean        @default(true)

  make  VehicleMake  @relation(fields: [makeId], references: [id], onDelete: Cascade)
  years VehicleYear[]

  @@unique([makeId, slug])
  @@index([makeId])
}

model VehicleYear {
  id         String  @id @default(cuid())
  year       Int
  modelId    String
  engineType String?
  bodyType   String?

  model        VehicleModel     @relation(fields: [modelId], references: [id], onDelete: Cascade)
  productLinks ProductVehicle[]

  @@unique([modelId, year, engineType])
  @@index([modelId])
  @@index([year])
}

model ProductVehicle {
  id            String @id @default(cuid())
  productId     String
  vehicleYearId String
  notes         String?

  product     Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  vehicleYear VehicleYear @relation(fields: [vehicleYearId], references: [id], onDelete: Cascade)

  @@unique([productId, vehicleYearId])
  @@index([productId])
  @@index([vehicleYearId])
}

model OemCrossReference {
  id          String @id @default(cuid())
  productId   String
  oemNumber   String
  brand       String
  description String?

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([oemNumber])
}

// ============================================================
// CART
// ============================================================

model Cart {
  id        String     @id @default(cuid())
  userId    String?    @unique
  sessionId String?    @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user  User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]
}

model CartItem {
  id        String @id @default(cuid())
  cartId    String
  productId String
  quantity  Int    @default(1)

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId])
  @@index([cartId])
}

// ============================================================
// ORDERS & PAYMENTS
// ============================================================

enum OrderStatus {
  PENDING
  PAYMENT_PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CLICK
  PAYME
  CASH_ON_DELIVERY
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

model Order {
  id              String        @id @default(cuid())
  orderNumber     String        @unique
  userId          String
  addressId       String?
  status          OrderStatus   @default(PENDING)
  paymentMethod   PaymentMethod
  subtotal        Decimal       @db.Decimal(12, 2)
  shippingCost    Decimal       @default(0) @db.Decimal(12, 2)
  discount        Decimal       @default(0) @db.Decimal(12, 2)
  total           Decimal       @db.Decimal(12, 2)
  customerNote    String?
  adminNote       String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user     User        @relation(fields: [userId], references: [id])
  address  Address?    @relation(fields: [addressId], references: [id])
  items    OrderItem[]
  payment  Payment?
  history  OrderStatusHistory[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id         String  @id @default(cuid())
  orderId    String
  productId  String
  quantity   Int
  unitPrice  Decimal @db.Decimal(12, 2)
  totalPrice Decimal @db.Decimal(12, 2)
  productName String
  productSku  String

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
}

model OrderStatusHistory {
  id        String      @id @default(cuid())
  orderId   String
  status    OrderStatus
  comment   String?
  changedBy String?
  createdAt DateTime    @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model Payment {
  id                String        @id @default(cuid())
  orderId           String        @unique
  method            PaymentMethod
  status            PaymentStatus @default(PENDING)
  amount            Decimal       @db.Decimal(12, 2)
  transactionId     String?
  providerData      Json?
  paidAt            DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([transactionId])
  @@index([status])
}

// ============================================================
// INVENTORY & WAREHOUSE
// ============================================================

model Inventory {
  id                String  @id @default(cuid())
  productId         String  @unique
  quantity          Int     @default(0)
  reservedQty       Int     @default(0)
  lowStockThreshold Int     @default(5)
  location          String?

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([quantity])
}

enum MovementType {
  INCOMING
  OUTGOING
  ADJUSTMENT
  RETURN
  RESERVATION
  RELEASE
}

model StockMovement {
  id          String       @id @default(cuid())
  productId   String
  type        MovementType
  quantity    Int
  reference   String?
  note        String?
  performedBy String?
  createdAt   DateTime     @default(now())

  product Product @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([type])
  @@index([createdAt])
}

// ============================================================
// SUPPLIERS & PURCHASE ORDERS
// ============================================================

model Supplier {
  id          String  @id @default(cuid())
  name        String
  contactName String?
  phone       String?
  email       String?
  address     String?
  notes       String?
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  purchaseOrders PurchaseOrder[]
}

enum PurchaseOrderStatus {
  DRAFT
  ORDERED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

model PurchaseOrder {
  id            String              @id @default(cuid())
  poNumber      String              @unique
  supplierId    String
  status        PurchaseOrderStatus @default(DRAFT)
  totalAmount   Decimal?            @db.Decimal(12, 2)
  notes         String?
  orderedAt     DateTime?
  receivedAt    DateTime?
  createdBy     String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  supplier Supplier            @relation(fields: [supplierId], references: [id])
  items    PurchaseOrderItem[]

  @@index([supplierId])
  @@index([status])
}

model PurchaseOrderItem {
  id              String  @id @default(cuid())
  purchaseOrderId String
  productId       String?
  productName     String
  quantity        Int
  receivedQty     Int     @default(0)
  unitCost        Decimal @db.Decimal(12, 2)

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
}

// ============================================================
// WISHLIST
// ============================================================

model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
}

// ============================================================
// CONTENT MANAGEMENT
// ============================================================

model Banner {
  id        String   @id @default(cuid())
  title     String
  subtitle  String?
  imageUrl  String
  linkUrl   String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  startDate DateTime?
  endDate   DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Page {
  id        String   @id @default(cuid())
  title     String
  slug      String   @unique
  content   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
}
